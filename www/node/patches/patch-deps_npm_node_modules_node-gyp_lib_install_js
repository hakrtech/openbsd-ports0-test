$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.1 2012/05/09 06:37:49 jasper Exp $

Allow building of sub-packages (ie. node-sqlite3) with USE_SYSTRACE
set, also prevents downloading of the node distfile again.

--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Tue May  8 20:06:20 2012
+++ deps/npm/node_modules/node-gyp/lib/install.js	Tue May  8 20:08:56 2012
@@ -166,11 +166,21 @@ function install (gyp, argv, callback) {
     extracter.on('error', cb)
     extracter.on('end', afterTarball)
 
-    // download the tarball, gunzip and extract!
-    var req = download(tarballUrl, downloadError)
-      .pipe(gunzip)
-      .pipe(extracter)
-
+	var filePath = '${DISTDIR}/node-v' + version + '.tar.gz';
+	gyp.info('If this fails, please ensure ' + filePath + ' exists!!')
+	fs.stat(filePath, function(err, stat) {
+		if (err) {
+			// download the tarball
+			var req = download(tarballUrl, downloadError)
+			  .pipe(gunzip)
+			  .pipe(extracter)
+		} else {
+			// use existing tarball
+			fs.createReadStream(filePath)
+			  .pipe(gunzip)
+			  .pipe(extracter)
+		}
+	});
     // something went wrong downloading the tarball?
     function downloadError (err, res) {
       if (err || res.statusCode != 200) {
