# $OpenBSD: Makefile,v 1.6 2014/06/27 00:09:29 sthen Exp $

# THIS IS A WORK IN PROGRESS, IT IS NOT YET READY FOR USE.
#
# Remaining problems:

# 1. tests fail for sthen but not rpe ... from cd ${WRKBUILD}; ctest --verbose:
#
# libicinga.so: undefined symbol '_ZN6icinga11AExpression9OpLiteralEPKS0_RKN5boost10shared_ptrINS_10DictionaryEEE'
# libicinga.so: undefined symbol '_ZN6icinga11AExpression5OpSetEPKS0_RKN5boost10shared_ptrINS_10DictionaryEEE'
# libicinga.so: undefined symbol '_ZN6icinga10ObjectRule12RegisterTypeERKNS_6StringERKN5boost8functionIFvRKSt6vectorIS0_SaIS0_EEEEE'
# lazy binding failed!
# Test setup error: memory access violation at address: 0x00000000: no mapping at fault address
#
# Only obvious difference in build log is that -rpath-link is ordered
# differently, /usr/X11R6/lib:/usr/local/lib vs /usr/local/lib:/usr/X11R6/lib

# 2. directory structure and chroot.
# icinga1 had a simple structure for directories written at runtime,
# basically just var/icinga and var/log/icinga, so easy to move into
# chroot (see core/pkg/README-main). icinga2 uses var/lib/icinga2,
# var/log/icinga2, var/run/icinga2, var/spool/icinga2; README needs
# adapting to move these into the right place, plus for OpenBSD hier
# it should use var/db/icinga2 rather than var/lib/icinga2

# 3. doesn't pick up libexecinfo. maybe FindBacktrace.cmake from
# audio/clementine will help

# 4. needs new gid for COMMAND_GROUP and set this in CONFIGURE_ARGS
# (upstream uses icingacmd)

SHARED_ONLY =	Yes

COMMENT-main =	network monitoring system
COMMENT-mysql =	MySQL support for icinga2
COMMENT-pgsql =	PostgreSQL support for icinga2

V =		2.0.0
DISTNAME =	icinga2-$V
PKGNAME-main =	icinga2-$V
PKGNAME-mysql =	icinga2-mysql-$V
PKGNAME-pgsql =	icinga2-pgsql-$V

HOMEPAGE =	https://www.icinga.org/icinga2/

# GPLv2+ with OpenSSL exemption
PERMIT_PACKAGE_CDROM =	Yes

WANTLIB += boost_program_options-mt boost_regex-mt boost_system-mt
WANTLIB += boost_thread-mt crypto execinfo m pthread ssl stdc++

MASTER_SITES =		https://github.com/Icinga/icinga2/archive/
# switch to a proper uploaded tar (rather than github autogenerated
# file) if one becomes available
DISTFILES =		${DISTNAME}{v${V}}${EXTRACT_SUFX}

MODULES =		devel/cmake

BUILD_DEPENDS =		devel/bison \
			devel/flex
LIB_DEPENDS =		devel/boost
RUN_DEPENDS =           ${BASE_PKGPATH},-main

MULTI_PACKAGES =	-main -mysql -pgsql

WANTLIB-main +=		${WANTLIB} c
RUN_DEPENDS-main =	net/nagios/plugins

WANTLIB-mysql +=	${WANTLIB} mysqlclient
LIB_DEPENDS-mysql =	${LIB_DEPENDS} databases/mysql
RUN_DEPENDS-mysql =	${BASE_PKGPATH},-main

WANTLIB-pgsql +=	${WANTLIB} pq
LIB_DEPENDS-pgsql =	${LIB_DEPENDS} databases/postgresql
RUN_DEPENDS-pgsql =	${BASE_PKGPATH},-main

CONFIGURE_ARGS += \
	-DCMAKE_INSTALL_MANDIR:String="${PREFIX}/man" \
	-DCMAKE_INSTALL_SYSCONFDIR:String="${SYSCONFDIR}" \
	-DCMAKE_INSTALL_LOCALSTATEDIR:String="${LOCALSTATEDIR}" \
	-DICINGA2_COMMAND_USER:String="_icinga" \
	-DICINGA2_COMMAND_GROUP:String="_icingacmd" \
	-DICINGA2_USER:String="_icinga" \
	-DICINGA2_GROUP:String="_icinga" \
	-DICINGA2_GIT_VERSION_INFO:Boolean="OFF" \
	-DICINGA2_SYSCONFIGFILE:String="${PREFIX}/share/examples/icinga2/sysconfig"

CFLAGS +=	-pthread
LDFLAGS +=	-lpthread

pre-configure:
	ln -sf ${LOCALBASE}/bin/gflex ${WRKDIR}/bin/flex
	@${SUBST_CMD} ${WRKSRC}/etc/icinga2/constants.conf

post-configure:
	perl -pi -e 's,}${SYSCONFDIR}/icinga2,}${TRUEPREFIX}/share/examples/icinga2,g' \
	    ${WRKBUILD}/etc/cmake_install.cmake

.include <bsd.port.mk>
