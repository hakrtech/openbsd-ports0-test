$OpenBSD: patch-src_main_c,v 1.2 2012/03/30 06:09:54 ajacoutot Exp $
--- src/main.c.orig	Tue Oct 11 06:44:58 2011
+++ src/main.c	Sat Mar 24 10:57:15 2012
@@ -41,7 +41,7 @@
 #include <errno.h>
 #include <string.h>
 #include <stdlib.h>
-#ifdef _POSIX_PRIORITY_SCHEDULING
+#if defined(_POSIX_PRIORITY_SCHEDULING) && (_POSIX_PRIORITY_SCHEDULING > 0)
 #include <sched.h>
 #endif
 #include "server.h"
@@ -200,7 +200,7 @@ void daemonize()
 		
 }
 
-#ifdef _POSIX_PRIORITY_SCHEDULING
+#if defined(_POSIX_PRIORITY_SCHEDULING) && (_POSIX_PRIORITY_SCHEDULING > 0)
 void setscheduler()
 {
 	int rc;
@@ -219,7 +219,7 @@ void printhelp()
 	printf("uMurmur version %s. Mumble protocol %d.%d.%d\n", UMURMUR_VERSION, PROTVER_MAJOR, PROTVER_MINOR, PROTVER_PATCH);
 	printf("Usage: umurmurd [-d] [-r] [-h] [-p <pidfile>] [-t] [-c <conf file>] [-a <addr>] [-b <port>]\n");
 	printf("       -d             - Do not daemonize - run in foreground.\n");
-#ifdef _POSIX_PRIORITY_SCHEDULING
+#if defined(_POSIX_PRIORITY_SCHEDULING) && (_POSIX_PRIORITY_SCHEDULING > 0)
 	printf("       -r             - Run with realtime priority\n");
 #endif
 	printf("       -p <pidfile>   - Write PID to this file\n");
@@ -234,15 +234,16 @@ void printhelp()
 int main(int argc, char **argv)
 {
 	bool_t nodaemon = false;
-#ifdef _POSIX_PRIORITY_SCHEDULING
-	bool_t realtime = false, testconfig = false;
+#if defined(_POSIX_PRIORITY_SCHEDULING) && (_POSIX_PRIORITY_SCHEDULING > 0)
+	bool_t realtime = false;
 #endif
+	bool_t testconfig = false;
 	char *conffile = NULL, *pidfile = NULL;
 	int c;
 	struct utsname utsbuf;
 	
 	/* Arguments */
-#ifdef _POSIX_PRIORITY_SCHEDULING
+#if defined(_POSIX_PRIORITY_SCHEDULING) && (_POSIX_PRIORITY_SCHEDULING > 0)
 	while ((c = getopt(argc, argv, "drp:c:a:b:ht")) != EOF) {
 #else
 	while ((c = getopt(argc, argv, "dp:c:a:b:ht")) != EOF) {
@@ -269,7 +270,7 @@ int main(int argc, char **argv)
 		case 't':
 			testconfig = true;
 			break;
-#ifdef _POSIX_PRIORITY_SCHEDULING
+#if defined(_POSIX_PRIORITY_SCHEDULING) && (_POSIX_PRIORITY_SCHEDULING > 0)
 		case 'r':
 			realtime = true;
 			break;
@@ -333,7 +334,7 @@ int main(int argc, char **argv)
 	Chan_init();
 	Client_init();
 
-#ifdef _POSIX_PRIORITY_SCHEDULING
+#if defined(_POSIX_PRIORITY_SCHEDULING) && (_POSIX_PRIORITY_SCHEDULING > 0)
 	if (realtime)
 		setscheduler();
 #endif
