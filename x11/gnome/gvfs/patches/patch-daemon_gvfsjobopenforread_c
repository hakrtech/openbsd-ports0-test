$OpenBSD: patch-daemon_gvfsjobopenforread_c,v 1.1 2013/04/05 14:07:31 ajacoutot Exp $

From a376e0808c2e8212462025d8065e60d091995d36 Mon Sep 17 00:00:00 2001
From: Tomas Bzatek <tbzatek@redhat.com>
Date: Wed, 03 Apr 2013 13:08:20 +0000
Subject: gvfschannel: Return proper error if we're out of free fds

--- daemon/gvfsjobopenforread.c.orig	Mon Mar 25 15:00:16 2013
+++ daemon/gvfsjobopenforread.c	Fri Apr  5 15:41:04 2013
@@ -174,7 +174,17 @@ create_reply (GVfsJob *job,
                                     open_job->pid);
 
   remote_fd = g_vfs_channel_steal_remote_fd (G_VFS_CHANNEL (channel));
-  
+  if (remote_fd < 0)
+    {
+      /* expecting we're out of fds when remote_fd == -1 */
+      g_dbus_method_invocation_return_error_literal (invocation,
+                                                     G_IO_ERROR,
+                                                     G_IO_ERROR_TOO_MANY_OPEN_FILES,
+                                                     _("Couldn't get stream file descriptor"));
+      g_object_unref (channel);
+      return;
+    }
+
   fd_list = g_unix_fd_list_new ();
   error = NULL;
   fd_id = g_unix_fd_list_append (fd_list, remote_fd, &error);
