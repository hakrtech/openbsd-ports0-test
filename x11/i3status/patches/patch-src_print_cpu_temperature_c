$OpenBSD: patch-src_print_cpu_temperature_c,v 1.1.1.1 2012/05/02 07:37:10 jasper Exp $

Implement basic fetching of cpu temperature on OpenBSD (committed upstream).

--- src/print_cpu_temperature.c.orig	Sun Apr 29 16:54:46 2012
+++ src/print_cpu_temperature.c	Sun Apr 29 16:54:56 2012
@@ -16,6 +16,15 @@
 #define TZ_KELVTOC(x) (((x) - TZ_ZEROC) / 10), abs(((x) - TZ_ZEROC) % 10)
 #endif
 
+#if defined(__OpenBSD__)
+#include <sys/param.h>
+#include <sys/types.h>
+#include <sys/sysctl.h>
+#include <sys/sensors.h>
+#include <errno.h>
+#include <err.h>
+#endif
+
 static char *thermal_zone;
 
 /*
@@ -59,11 +68,46 @@ void print_cpu_temperature_info(yajl_gen json_gen, cha
                                 goto error;
 
                         outwalk += sprintf(outwalk, "%d.%d", TZ_KELVTOC(sysctl_rslt));
+#elif defined(__OpenBSD__)
+	struct sensordev sensordev;
+	struct sensor sensor;
+	size_t sdlen, slen;
+	int dev, numt, mib[5] = { CTL_HW, HW_SENSORS, 0, 0, 0 };
+
+	sdlen = sizeof(sensordev);
+	slen = sizeof(sensor);
+
+	for (dev = 0; ; dev++) {
+		mib[2] = dev;
+		if (sysctl(mib, 3, &sensordev, &sdlen, NULL, 0) == -1) {
+			if (errno == ENXIO)
+				continue;
+			if (errno == ENOENT)
+				break;
+			goto error;
+		}
+		/*
+		 * 'path' is actually the node within the full path (eg, cpu0).
+		 * XXX: Extend the API to allow a string instead of just an int for path, this would
+		 * allow us to have a path of 'acpitz0' for example.
+		 */
+		if (strncmp(sensordev.xname, path, strlen(path)) == 0) {
+			mib[3] = SENSOR_TEMP;
+			for (numt = 0; numt < sensordev.maxnumt[SENSOR_TEMP]; numt++) {
+				mib[4] = numt;
+				if (sysctl(mib, 5, &sensor, &slen, NULL, 0) == -1) {
+					if (errno != ENOENT)
+						warn("sysctl");
+					continue;
+				}
+				outwalk += sprintf(outwalk, "%.2f", (sensor.value - 273150000) / 1000000.0 );
+			}
+		}
+	}
 #endif
                         walk += strlen("degrees");
                 }
         }
-
         OUTPUT_FULL_TEXT(buffer);
         return;
 error:
