$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.4 2014/05/06 03:10:08 abieber Exp $

Allow building of sub-packages (ie. node-sqlite3) with USE_SYSTRACE
set, also prevents downloading of the node distfile again.

--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Thu May  1 18:47:47 2014
+++ deps/npm/node_modules/node-gyp/lib/install.js	Mon May  5 16:17:34 2014
@@ -222,37 +222,18 @@ function install (gyp, argv, callback) {
         return
       }
 
-      var req = download(tarballUrl)
-      if (!req) return
-
-      // something went wrong downloading the tarball?
-      req.on('error', function (err) {
-        badDownload = true
-        cb(err)
-      })
-
-      req.on('close', function () {
-        if (extractCount === 0) {
-          cb(new Error('Connection closed while downloading tarball file'))
-        }
-      })
-
-      req.on('response', function (res) {
-        if (res.statusCode !== 200) {
-          badDownload = true
-          cb(new Error(res.statusCode + ' status code downloading tarball'))
-          return
-        }
-        // content sha1
-        getContentSha(res, function (_, sha1) {
-          var filename = path.basename(tarballUrl).trim()
-          contentShasums[filename] = sha1
-          log.verbose('content sha1', filename, sha1)
-        })
-
-        // start unzipping and untaring
-        req.pipe(gunzip).pipe(extracter)
-      })
+      // OpenBSD fix
+      var filePath = '${PREFIX}/lib/node/${DISTFILES}';
+      fs.stat(filePath, function(err, stat) {
+        if (err) {
+          throw err;
+        } else {
+          fs.createReadStream(filePath)
+            .pipe(gunzip)
+            .pipe(extracter)
+         }
+       })
+      // OpenBSD fix
 
       // invoked after the tarball has finished being extracted
       function afterTarball () {
